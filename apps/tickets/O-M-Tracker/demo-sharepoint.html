<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Clearsol O&M Portfolio Tracker</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root {
            --bg: #f8fafc;
            --sidebar: #111827;
            --card: #ffffff;
            --border: #e5e7eb;
            --text: #1f2937;
            --text-muted: #6b7280;
            --blue: #3b82f6;
            --green: #10b981;
            --amber: #f59e0b;
            --purple: #8b5cf6;
            --red: #ef4444;
        }
        
        * { box-sizing: border-box; margin: 0; padding: 0; }
        
        body {
            font-family: 'Inter', -apple-system, sans-serif;
            background: var(--bg);
            color: var(--text);
            display: flex;
            min-height: 100vh;
        }
        
        /* Sidebar */
        .sidebar {
            width: 256px;
            background: var(--sidebar);
            color: white;
            display: flex;
            flex-direction: column;
            position: fixed;
            height: 100vh;
            z-index: 100;
        }
        
        .logo {
            padding: 20px 24px;
            display: flex;
            align-items: center;
            gap: 12px;
            border-bottom: 1px solid #374151;
        }
        
        .logo-icon {
            width: 40px;
            height: 40px;
            background: linear-gradient(135deg, #f59e0b, #ea580c);
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
        }
        
        .logo-text {
            font-weight: 700;
            font-size: 18px;
        }
        
        .nav {
            flex: 1;
            padding: 16px;
        }
        
        .nav-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 10px 12px;
            border-radius: 8px;
            color: #9ca3af;
            cursor: pointer;
            margin-bottom: 4px;
            transition: all 0.2s;
            text-decoration: none;
        }
        
        .nav-item:hover, .nav-item.active {
            background: #1f2937;
            color: white;
        }
        
        .nav-item.active .nav-icon {
            color: var(--blue);
        }
        
        .nav-icon {
            width: 20px;
            text-align: center;
        }
        
        .sidebar-footer {
            padding: 16px;
            border-top: 1px solid #374151;
            font-size: 12px;
            color: #6b7280;
        }
        
        /* Main Content */
        .main {
            flex: 1;
            margin-left: 256px;
            min-height: 100vh;
        }
        
        .header {
            background: white;
            border-bottom: 1px solid var(--border);
            padding: 20px 32px;
        }
        
        .header h1 {
            font-size: 24px;
            font-weight: 700;
            margin-bottom: 4px;
        }
        
        .header p {
            color: var(--text-muted);
            font-size: 14px;
        }
        
        .content {
            padding: 24px 32px;
        }
        
        /* Cards */
        .card {
            background: var(--card);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 20px;
        }
        
        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
        }
        
        .card-title {
            font-size: 13px;
            font-weight: 500;
            color: var(--text-muted);
        }
        
        .card-icon {
            width: 36px;
            height: 36px;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
        }
        
        .card-icon.blue { background: #dbeafe; }
        .card-icon.amber { background: #fef3c7; }
        .card-icon.green { background: #d1fae5; }
        .card-icon.purple { background: #ede9fe; }
        
        .card-value {
            font-size: 30px;
            font-weight: 700;
            margin-bottom: 4px;
        }
        
        .card-sub {
            font-size: 13px;
            color: var(--text-muted);
        }
        
        .card-sub span {
            color: var(--green);
            font-weight: 600;
        }
        
        /* Stats Grid */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 20px;
            margin-bottom: 24px;
        }
        
        /* Charts Grid */
        .charts-grid {
            display: grid;
            grid-template-columns: 2fr 1fr;
            gap: 20px;
            margin-bottom: 24px;
        }
        
        .chart-card {
            background: var(--card);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 20px;
        }
        
        .chart-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 16px;
        }
        
        .chart-title {
            font-size: 16px;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .badge {
            padding: 4px 10px;
            border-radius: 999px;
            font-size: 12px;
            font-weight: 500;
        }
        
        .badge-blue { background: #dbeafe; color: #1d4ed8; }
        .badge-green { background: #d1fae5; color: #047857; }
        .badge-amber { background: #fef3c7; color: #b45309; }
        
        /* Bottom Grid */
        .bottom-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 24px;
        }
        
        /* Table */
        .table-container {
            overflow-x: auto;
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
        }
        
        th {
            text-align: left;
            padding: 12px;
            font-size: 11px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            color: var(--text-muted);
            background: #f9fafb;
            border-bottom: 1px solid var(--border);
        }
        
        td {
            padding: 12px;
            font-size: 14px;
            border-bottom: 1px solid var(--border);
        }
        
        tr:hover td {
            background: #f9fafb;
        }
        
        .site-link {
            color: var(--blue);
            font-weight: 500;
            text-decoration: none;
        }
        
        .site-link:hover {
            text-decoration: underline;
        }
        
        .status-badge {
            padding: 3px 8px;
            border-radius: 999px;
            font-size: 12px;
            font-weight: 500;
        }
        
        .status-yes { background: #d1fae5; color: #047857; }
        .status-no { background: #f3f4f6; color: #6b7280; }
        
        /* Top Sites */
        .top-site {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 12px;
            border-radius: 8px;
            transition: background 0.2s;
            cursor: pointer;
        }
        
        .top-site:hover {
            background: #f9fafb;
        }
        
        .top-site-info {
            display: flex;
            align-items: center;
            gap: 12px;
        }
        
        .top-site-rank {
            width: 32px;
            height: 32px;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
            font-size: 14px;
        }
        
        .rank-1 { background: #fef3c7; color: #b45309; }
        .rank-2 { background: #e5e7eb; color: #4b5563; }
        .rank-3 { background: #fed7aa; color: #c2410c; }
        .rank-default { background: #f3f4f6; color: #6b7280; }
        
        .top-site-name {
            font-weight: 500;
        }
        
        .top-site-meta {
            font-size: 12px;
            color: var(--text-muted);
        }
        
        .top-site-fee {
            font-weight: 600;
            color: var(--green);
        }
        
        .top-site-fee span {
            font-size: 11px;
            color: var(--text-muted);
            font-weight: 400;
        }
        
        /* Quick Actions */
        .action-card {
            display: block;
            padding: 16px;
            border: 1px solid var(--border);
            border-radius: 8px;
            transition: all 0.2s;
            text-decoration: none;
            color: inherit;
        }
        
        .action-card:hover {
            border-color: var(--blue);
            background: #eff6ff;
        }
        
        .action-icon {
            font-size: 28px;
            margin-bottom: 8px;
        }
        
        .action-title {
            font-weight: 600;
            margin-bottom: 4px;
        }
        
        .action-desc {
            font-size: 13px;
            color: var(--text-muted);
        }
        
        .actions-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 16px;
        }
        
        /* Page Views */
        .page {
            display: none;
        }
        
        .page.active {
            display: block;
        }
        
        /* SPV Cards */
        .spv-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 20px;
            margin-top: 20px;
        }
        
        .spv-card {
            background: var(--card);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 20px;
            transition: all 0.2s;
        }
        
        .spv-card:hover {
            box-shadow: 0 10px 25px rgba(0,0,0,0.1);
            transform: translateY(-2px);
        }
        
        .spv-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 12px;
        }
        
        .spv-code {
            padding: 4px 10px;
            background: #dbeafe;
            color: #1d4ed8;
            border-radius: 6px;
            font-size: 12px;
            font-weight: 600;
        }
        
        .spv-name {
            font-size: 16px;
            font-weight: 600;
            margin-top: 8px;
        }
        
        .spv-stats {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
            margin-top: 16px;
        }
        
        .spv-stat-label {
            font-size: 12px;
            color: var(--text-muted);
        }
        
        .spv-stat-value {
            font-size: 18px;
            font-weight: 600;
        }
        
        .spv-revenue {
            grid-column: span 2;
            padding-top: 12px;
            border-top: 1px solid var(--border);
            margin-top: 4px;
        }
        
        .spv-revenue .spv-stat-value {
            font-size: 24px;
            color: var(--green);
        }
        
        /* Search */
        .search-box {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px 12px;
            background: white;
            border: 1px solid var(--border);
            border-radius: 8px;
            max-width: 300px;
            margin-bottom: 16px;
        }
        
        .search-box input {
            border: none;
            outline: none;
            flex: 1;
            font-family: inherit;
            font-size: 14px;
        }
        
        /* Responsive */
        @media (max-width: 1200px) {
            .stats-grid { grid-template-columns: repeat(2, 1fr); }
            .charts-grid { grid-template-columns: 1fr; }
            .bottom-grid { grid-template-columns: 1fr; }
            .spv-grid { grid-template-columns: repeat(2, 1fr); }
            .actions-grid { grid-template-columns: 1fr; }
        }
        
        @media (max-width: 768px) {
            .sidebar { 
                width: 100%;
                height: auto;
                position: relative;
            }
            .main { margin-left: 0; }
            .stats-grid { grid-template-columns: 1fr; }
            .spv-grid { grid-template-columns: 1fr; }
            .content { padding: 16px; }
        }
    </style>
</head>
<body>
    <!-- Sidebar -->
    <aside class="sidebar">
        <div class="logo">
            <div class="logo-icon">‚ö°</div>
            <div class="logo-text">Clearsol O&M</div>
        </div>
        <nav class="nav">
            <a href="#" class="nav-item active" onclick="showPage('dashboard')">
                <span class="nav-icon">üìä</span>
                Dashboard
            </a>
            <a href="#" class="nav-item" onclick="showPage('sites')">
                <span class="nav-icon">üè¢</span>
                Sites
            </a>
            <a href="#" class="nav-item" onclick="showPage('spvs')">
                <span class="nav-icon">üíº</span>
                SPV Portfolio
            </a>
            <a href="#" class="nav-item" onclick="showPage('cmdays')">
                <span class="nav-icon">üîß</span>
                CM Days
            </a>
            <a href="#" class="nav-item" onclick="showPage('import')">
                <span class="nav-icon">üì•</span>
                Import Data
            </a>
            <a href="#" class="nav-item" onclick="showPage('settings')">
                <span class="nav-icon">‚öôÔ∏è</span>
                Settings
            </a>
        </nav>
        <div class="sidebar-footer">
            Portfolio Tracker v2.0
        </div>
    </aside>

    <!-- Main Content -->
    <main class="main">
        <!-- Dashboard Page -->
        <div id="dashboard" class="page active">
            <div class="header">
                <h1>Dashboard</h1>
                <p>Portfolio Overview</p>
            </div>
            <div class="content">
                <!-- Stats -->
                <div class="stats-grid">
                    <div class="card" style="background: linear-gradient(135deg, #eff6ff, white);">
                        <div class="card-header">
                            <span class="card-title">Total Sites</span>
                            <div class="card-icon blue">üè¢</div>
                        </div>
                        <div class="card-value">47</div>
                        <div class="card-sub"><span>38</span> contracted</div>
                    </div>
                    <div class="card" style="background: linear-gradient(135deg, #fefce8, white);">
                        <div class="card-header">
                            <span class="card-title">Total Capacity</span>
                            <div class="card-icon amber">‚ö°</div>
                        </div>
                        <div class="card-value">24.8 MW</div>
                        <div class="card-sub"><span>19.2 MW</span> contracted</div>
                    </div>
                    <div class="card" style="background: linear-gradient(135deg, #ecfdf5, white);">
                        <div class="card-header">
                            <span class="card-title">Monthly Revenue</span>
                            <div class="card-icon green">üí∑</div>
                        </div>
                        <div class="card-value">¬£38,420</div>
                        <div class="card-sub"><span>¬£461,040</span> annually</div>
                    </div>
                    <div class="card" style="background: linear-gradient(135deg, #faf5ff, white);">
                        <div class="card-header">
                            <span class="card-title">Current Tier</span>
                            <div class="card-icon purple">üìÖ</div>
                        </div>
                        <div class="card-value">20-30MW</div>
                        <div class="card-sub"><span>¬£1.80</span>/kWp rate</div>
                    </div>
                </div>

                <!-- CM Days Tracker -->
                <div class="chart-card" style="margin-bottom: 24px;">
                    <div class="chart-header">
                        <div class="chart-title">üîß Corrective Maintenance Days</div>
                        <span class="badge badge-blue" id="currentMonth">November 2025</span>
                    </div>
                    <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 24px; margin-top: 16px;">
                        <!-- Allowed -->
                        <div style="text-align: center; padding: 20px; background: #f0fdf4; border-radius: 12px; border: 1px solid #bbf7d0;">
                            <div style="font-size: 12px; color: var(--text-muted); margin-bottom: 4px;">ALLOWED / MONTH</div>
                            <div style="font-size: 36px; font-weight: 700; color: #16a34a;" id="cmAllowed">1.60</div>
                            <div style="font-size: 13px; color: var(--text-muted);">days</div>
                        </div>
                        <!-- Used -->
                        <div style="text-align: center; padding: 20px; background: #fef3c7; border-radius: 12px; border: 1px solid #fcd34d;">
                            <div style="font-size: 12px; color: var(--text-muted); margin-bottom: 4px;">USED THIS MONTH</div>
                            <div style="font-size: 36px; font-weight: 700; color: #d97706;" id="cmUsed">0.75</div>
                            <div style="font-size: 13px; color: var(--text-muted);">days</div>
                        </div>
                        <!-- Remaining -->
                        <div style="text-align: center; padding: 20px; background: #dbeafe; border-radius: 12px; border: 1px solid #93c5fd;">
                            <div style="font-size: 12px; color: var(--text-muted); margin-bottom: 4px;">REMAINING</div>
                            <div style="font-size: 36px; font-weight: 700; color: #2563eb;" id="cmRemaining">0.85</div>
                            <div style="font-size: 13px; color: var(--text-muted);">days</div>
                        </div>
                    </div>
                    <!-- Progress Bar -->
                    <div style="margin-top: 20px;">
                        <div style="display: flex; justify-content: space-between; font-size: 13px; margin-bottom: 8px;">
                            <span style="color: var(--text-muted);">Usage Progress</span>
                            <span style="font-weight: 600;" id="cmPercent">46.9% used</span>
                        </div>
                        <div style="height: 12px; background: #e5e7eb; border-radius: 999px; overflow: hidden;">
                            <div id="cmProgressBar" style="height: 100%; width: 46.9%; background: linear-gradient(90deg, #10b981, #f59e0b); border-radius: 999px; transition: width 0.5s;"></div>
                        </div>
                    </div>
                    <!-- Formula explanation -->
                    <div style="margin-top: 16px; padding: 12px; background: #f9fafb; border-radius: 8px; font-size: 13px; color: var(--text-muted);">
                        <strong>Formula:</strong> CM Days Allowed = Contracted Capacity (MW) √∑ 12 = <span id="cmFormula">19.2 MW √∑ 12 = 1.60 days/month</span>
                    </div>
                </div>

                <!-- Monthly CM History -->
                <div class="chart-card" style="margin-bottom: 24px;">
                    <div class="chart-header">
                        <div class="chart-title">üìä CM Days History</div>
                        <span class="badge badge-green">Last 6 months</span>
                    </div>
                    <div class="table-container" style="margin-top: 16px;">
                        <table>
                            <thead>
                                <tr>
                                    <th>Month</th>
                                    <th>Allowed</th>
                                    <th>Used</th>
                                    <th>Remaining</th>
                                    <th>Status</th>
                                </tr>
                            </thead>
                            <tbody id="cmHistoryTable">
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- Charts -->
                <div class="charts-grid">
                    <div class="chart-card">
                        <div class="chart-header">
                            <div class="chart-title">
                                üìà Revenue Trend
                            </div>
                            <span class="badge badge-blue">Last 12 months</span>
                        </div>
                        <canvas id="revenueChart" height="120"></canvas>
                    </div>
                    <div class="chart-card">
                        <div class="chart-header">
                            <div class="chart-title">Contract Status</div>
                        </div>
                        <canvas id="contractChart" height="180"></canvas>
                        <div style="margin-top: 16px; padding-top: 16px; border-top: 1px solid var(--border);">
                            <div style="display: flex; justify-content: space-between; font-size: 14px; margin-bottom: 8px;">
                                <span style="color: var(--text-muted);">Contracted</span>
                                <span style="font-weight: 600;">38 sites</span>
                            </div>
                            <div style="display: flex; justify-content: space-between; font-size: 14px;">
                                <span style="color: var(--text-muted);">Not Contracted</span>
                                <span style="font-weight: 600;">9 sites</span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Bottom Section -->
                <div class="bottom-grid">
                    <div class="chart-card">
                        <div class="chart-header">
                            <div class="chart-title">Capacity by SPV</div>
                            <a href="#" onclick="showPage('spvs')" style="font-size: 14px; color: var(--blue); text-decoration: none;">View all ‚Üí</a>
                        </div>
                        <canvas id="spvChart" height="150"></canvas>
                    </div>
                    <div class="chart-card">
                        <div class="chart-header">
                            <div class="chart-title">üèÜ Top Earning Sites</div>
                            <a href="#" onclick="showPage('sites')" style="font-size: 14px; color: var(--blue); text-decoration: none;">View all ‚Üí</a>
                        </div>
                        <div id="topSites"></div>
                    </div>
                </div>

                <!-- Quick Actions -->
                <div class="chart-card">
                    <div class="chart-title" style="margin-bottom: 16px;">Quick Actions</div>
                    <div class="actions-grid">
                        <a href="#" class="action-card" onclick="showPage('sites')">
                            <div class="action-icon">üè¢</div>
                            <div class="action-title">View All Sites</div>
                            <div class="action-desc">Browse and manage your portfolio sites</div>
                        </a>
                        <a href="#" class="action-card" onclick="showPage('sites')">
                            <div class="action-icon">‚ûï</div>
                            <div class="action-title">Add New Site</div>
                            <div class="action-desc">Create a new site entry manually</div>
                        </a>
                        <a href="#" class="action-card" onclick="showPage('import')">
                            <div class="action-icon">üì•</div>
                            <div class="action-title">Import from Excel</div>
                            <div class="action-desc">Bulk import sites from your spreadsheet</div>
                        </a>
                    </div>
                </div>
            </div>
        </div>

        <!-- Sites Page -->
        <div id="sites" class="page">
            <div class="header">
                <h1>Sites</h1>
                <p>47 sites in portfolio</p>
            </div>
            <div class="content">
                <div class="search-box">
                    <span>üîç</span>
                    <input type="text" placeholder="Search sites..." id="siteSearch" onkeyup="filterSites()">
                </div>
                <div class="chart-card">
                    <div class="table-container">
                        <table id="sitesTable">
                            <thead>
                                <tr>
                                    <th>Site Name</th>
                                    <th>Size (kWp)</th>
                                    <th>Type</th>
                                    <th>Contract</th>
                                    <th>Onboard Date</th>
                                    <th>SPV</th>
                                    <th>PM Cost</th>
                                    <th>CCTV Cost</th>
                                    <th>Cleaning Cost</th>
                                    <th>Monthly Fee</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="sitesBody"></tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <!-- SPV Portfolio Page -->
        <div id="spvs" class="page">
            <div class="header">
                <h1>SPV Portfolio</h1>
                <p>Special Purpose Vehicle breakdown and invoicing</p>
            </div>
            <div class="content">
                <!-- SPV Summary Stats -->
                <div class="stats-grid" style="grid-template-columns: repeat(3, 1fr);">
                    <div class="card">
                        <div class="card-header">
                            <span class="card-title">Total SPVs</span>
                            <div class="card-icon blue">üíº</div>
                        </div>
                        <div class="card-value">8</div>
                        <div class="card-sub">47 sites total</div>
                    </div>
                    <div class="card">
                        <div class="card-header">
                            <span class="card-title">Total Capacity</span>
                            <div class="card-icon amber">‚ö°</div>
                        </div>
                        <div class="card-value">24.8 MW</div>
                        <div class="card-sub">Across all SPVs</div>
                    </div>
                    <div class="card">
                        <div class="card-header">
                            <span class="card-title">Monthly Revenue</span>
                            <div class="card-icon green">üí∑</div>
                        </div>
                        <div class="card-value">¬£38,420</div>
                        <div class="card-sub">From contracted sites</div>
                    </div>
                </div>

                <div class="chart-card">
                    <div class="chart-header">
                        <div class="chart-title">üìä SPV Breakdown</div>
                    </div>
                    <div class="table-container">
                        <table>
                            <thead>
                                <tr>
                                    <th>SPV Code</th>
                                    <th>SPV Name</th>
                                    <th>Total Sites</th>
                                    <th>Contracted</th>
                                    <th>Capacity (MW)</th>
                                    <th>Monthly Revenue</th>
                                    <th>Annual Revenue</th>
                                </tr>
                            </thead>
                            <tbody id="spvsBody"></tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <!-- Import Page -->
        <div id="import" class="page">
            <div class="header">
                <h1>Import Data</h1>
                <p>Import sites from Excel spreadsheet</p>
            </div>
            <div class="content">
                <div class="chart-card" style="max-width: 800px;">
                    <h3 style="margin-bottom: 8px;">Import from CSV</h3>
                    <p style="color: var(--text-muted); margin-bottom: 12px;">Upload your Clearsol O&M Framework Tracker spreadsheet as CSV. The importer auto-detects your column structure.</p>
                    <div style="background: #fef3c7; border: 1px solid #fcd34d; border-radius: 8px; padding: 12px; margin-bottom: 20px; font-size: 13px; color: #92400e;">
                        <strong>üìù How to convert Excel to CSV:</strong><br>
                        1. Open your Excel file in Excel or Google Sheets<br>
                        2. File ‚Üí Download As ‚Üí Comma-Separated Values (.csv)<br>
                        3. Upload the CSV file below
                    </div>
                    <div id="importZone" style="border: 2px dashed var(--border); border-radius: 12px; padding: 40px; text-align: center; cursor: pointer; transition: all 0.2s;">
                        <input type="file" id="fileInput" accept=".csv" style="display: none;">
                        <div style="font-size: 48px; margin-bottom: 16px;">üìÑ</div>
                        <p><strong style="color: var(--blue);">Click to upload</strong> or drag and drop</p>
                        <p style="font-size: 12px; color: var(--text-muted);">CSV files (.csv)</p>
                    </div>
                    <div id="importStatus" style="margin-top: 12px; color: var(--green); display: none;"></div>
                    <div id="columnMappingUI" style="margin-top: 20px; display: none;">
                        <h4>Column Mapping (Preview of first 5 rows)</h4>
                        <div id="mappingTable" style="max-height: 300px; overflow-y: auto; margin: 16px 0; border: 1px solid var(--border); border-radius: 8px; padding: 12px;"></div>
                        <div style="display: flex; gap: 12px;">
                            <button onclick="confirmImport()" style="flex: 1; padding: 10px; background: var(--green); color: white; border: none; border-radius: 8px; font-weight: 600; cursor: pointer;">‚úÖ Import Data</button>
                            <button onclick="cancelImport()" style="flex: 1; padding: 10px; background: #e5e7eb; color: var(--text); border: none; border-radius: 8px; font-weight: 600; cursor: pointer;">‚ùå Cancel</button>
                        </div>
                    </div>
                </div>
                
                <div class="chart-card" style="max-width: 600px; margin-top: 20px;">
                    <h3 style="margin-bottom: 16px;">Import Requirements</h3>
                    <ul style="list-style: none; font-size: 14px; color: var(--text-muted);">
                        <li style="margin-bottom: 8px;">‚Ä¢ The spreadsheet must contain a "Portfolio Tracker" tab</li>
                        <li style="margin-bottom: 8px;">‚Ä¢ Site data should start from row 5 (rows 1-4 are headers)</li>
                        <li style="margin-bottom: 8px;">‚Ä¢ Required columns: Site Name (C), System Size (D)</li>
                        <li style="margin-bottom: 8px;">‚Ä¢ Optional columns: Contract (E), Onboard Date (F), PM Cost (G), CCTV (H), Cleaning (I), SPV (V)</li>
                        <li style="color: #b45309;">‚ö†Ô∏è Importing will replace all existing site data</li>
                    </ul>
                </div>
            </div>
        </div>

        <!-- CM Days Page -->
        <div id="cmdays" class="page">
            <div class="header">
                <h1>Corrective Maintenance Days</h1>
                <p>Track and manage CM day allowances</p>
            </div>
            <div class="content">
                <!-- Current Month Summary -->
                <div class="stats-grid" style="grid-template-columns: repeat(4, 1fr);">
                    <div class="card" style="background: linear-gradient(135deg, #f0fdf4, white);">
                        <div class="card-header">
                            <span class="card-title">Allowed</span>
                            <div class="card-icon green">‚úì</div>
                        </div>
                        <div class="card-value" style="color: #16a34a;">1.60</div>
                        <div class="card-sub">days this month</div>
                    </div>
                    <div class="card" style="background: linear-gradient(135deg, #fef3c7, white);">
                        <div class="card-header">
                            <span class="card-title">Used</span>
                            <div class="card-icon amber">üîß</div>
                        </div>
                        <div class="card-value" style="color: #d97706;">0.75</div>
                        <div class="card-sub">days used</div>
                    </div>
                    <div class="card" style="background: linear-gradient(135deg, #dbeafe, white);">
                        <div class="card-header">
                            <span class="card-title">Remaining</span>
                            <div class="card-icon blue">‚è≥</div>
                        </div>
                        <div class="card-value" style="color: #2563eb;">0.85</div>
                        <div class="card-sub">days left</div>
                    </div>
                    <div class="card" style="background: linear-gradient(135deg, #faf5ff, white);">
                        <div class="card-header">
                            <span class="card-title">YTD Rollover</span>
                            <div class="card-icon purple">üìä</div>
                        </div>
                        <div class="card-value" style="color: #7c3aed;">+2.35</div>
                        <div class="card-sub">days banked</div>
                    </div>
                </div>

                <!-- Log CM Work -->
                <div class="chart-card" style="margin-bottom: 24px;">
                    <div class="chart-title" style="margin-bottom: 16px;">‚ûï Log CM Work</div>
                    <div style="display: grid; grid-template-columns: 2fr 1fr 1fr 1fr auto; gap: 12px; align-items: end;">
                        <div>
                            <label style="display: block; font-size: 13px; color: var(--text-muted); margin-bottom: 4px;">Site</label>
                            <select style="width: 100%; padding: 10px; border: 1px solid var(--border); border-radius: 8px;">
                                <option>Select site...</option>
                                <option>Meadow Solar Farm</option>
                                <option>Hilltop Energy Park</option>
                                <option>Valley View Solar</option>
                                <option>Sunrise Industrial</option>
                                <option>Northfield Array</option>
                            </select>
                        </div>
                        <div>
                            <label style="display: block; font-size: 13px; color: var(--text-muted); margin-bottom: 4px;">Date</label>
                            <input type="date" style="width: 100%; padding: 10px; border: 1px solid var(--border); border-radius: 8px;">
                        </div>
                        <div>
                            <label style="display: block; font-size: 13px; color: var(--text-muted); margin-bottom: 4px;">Hours</label>
                            <input type="number" placeholder="0.0" step="0.5" style="width: 100%; padding: 10px; border: 1px solid var(--border); border-radius: 8px;">
                        </div>
                        <div>
                            <label style="display: block; font-size: 13px; color: var(--text-muted); margin-bottom: 4px;">Days (√∑8)</label>
                            <input type="text" value="0.00" disabled style="width: 100%; padding: 10px; border: 1px solid var(--border); border-radius: 8px; background: #f9fafb;">
                        </div>
                        <button style="padding: 10px 20px; background: var(--blue); color: white; border: none; border-radius: 8px; font-weight: 600; cursor: pointer;">
                            Add
                        </button>
                    </div>
                </div>

                <!-- CM Work Log -->
                <div class="chart-card" style="margin-bottom: 24px;">
                    <div class="chart-header">
                        <div class="chart-title">üìã November 2025 Work Log</div>
                        <button style="padding: 6px 12px; background: white; border: 1px solid var(--border); border-radius: 6px; font-size: 12px; cursor: pointer;">
                            üì• Export
                        </button>
                    </div>
                    <div class="table-container" style="margin-top: 16px;">
                        <table>
                            <thead>
                                <tr>
                                    <th>Date</th>
                                    <th>Site</th>
                                    <th>Description</th>
                                    <th>Hours</th>
                                    <th>Days</th>
                                    <th>Technician</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td>15 Nov 2025</td>
                                    <td><a href="#" class="site-link">Valley View Solar</a></td>
                                    <td>Inverter fault repair</td>
                                    <td>4.0</td>
                                    <td style="font-weight: 600;">0.50</td>
                                    <td>John Smith</td>
                                </tr>
                                <tr>
                                    <td>08 Nov 2025</td>
                                    <td><a href="#" class="site-link">Meadow Solar Farm</a></td>
                                    <td>Panel cleaning after storm</td>
                                    <td>2.0</td>
                                    <td style="font-weight: 600;">0.25</td>
                                    <td>Mike Johnson</td>
                                </tr>
                            </tbody>
                            <tfoot style="background: #f9fafb;">
                                <tr>
                                    <td colspan="3" style="font-weight: 600;">Total for November</td>
                                    <td style="font-weight: 600;">6.0 hrs</td>
                                    <td style="font-weight: 700; color: var(--amber);">0.75 days</td>
                                    <td></td>
                                </tr>
                            </tfoot>
                        </table>
                    </div>
                </div>

                <!-- Monthly Summary Chart -->
                <div class="chart-card">
                    <div class="chart-header">
                        <div class="chart-title">üìà Monthly CM Usage vs Allowance</div>
                        <span class="badge badge-blue">Last 12 months</span>
                    </div>
                    <canvas id="cmUsageChart" height="100"></canvas>
                </div>
            </div>
        </div>

        <!-- Settings Page -->
        <div id="settings" class="page">
            <div class="header">
                <h1>Settings</h1>
                <p>Configure portfolio settings</p>
            </div>
            <div class="content">
                <div class="chart-card" style="max-width: 600px;">
                    <h3 style="margin-bottom: 8px;">Rate Tiers</h3>
                    <p style="color: var(--text-muted); margin-bottom: 20px;">Current portfolio cost rates by capacity tier.</p>
                    
                    <table>
                        <thead>
                            <tr>
                                <th>Tier</th>
                                <th>Capacity Range</th>
                                <th style="text-align: right;">Rate (¬£/kWp)</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td style="font-weight: 600;">&lt;20MW</td>
                                <td style="color: var(--text-muted);">0 - 20 MW</td>
                                <td style="text-align: right;">¬£2.00</td>
                            </tr>
                            <tr>
                                <td style="font-weight: 600;">20-30MW</td>
                                <td style="color: var(--text-muted);">20 - 30 MW</td>
                                <td style="text-align: right;">¬£1.80</td>
                            </tr>
                            <tr>
                                <td style="font-weight: 600;">30-40MW</td>
                                <td style="color: var(--text-muted);">30 - 40 MW</td>
                                <td style="text-align: right;">¬£1.70</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
                
                <div class="chart-card" style="max-width: 600px; margin-top: 20px;">
                    <h3 style="margin-bottom: 16px;">Coming Soon</h3>
                    <ul style="list-style: none; font-size: 14px; color: var(--text-muted);">
                        <li style="margin-bottom: 8px;">‚Ä¢ User management and authentication</li>
                        <li style="margin-bottom: 8px;">‚Ä¢ Custom rate tier configuration</li>
                        <li style="margin-bottom: 8px;">‚Ä¢ Audit log viewer</li>
                        <li>‚Ä¢ Export settings</li>
                    </ul>
                </div>
            </div>
        </div>
    </main>

    <!-- Site Detail Modal -->
    <div id="siteDetailModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000; align-items: center; justify-content: center; flex-direction: column;">
        <div style="background: white; border-radius: 12px; max-width: 500px; width: 90%; max-height: 80vh; overflow-y: auto; padding: 24px; box-shadow: 0 20px 60px rgba(0,0,0,0.3); position: relative;">
            <button onclick="closeSiteModal()" style="position: absolute; top: 12px; right: 16px; background: none; border: none; font-size: 24px; cursor: pointer; color: #6b7280;">&times;</button>
            <h2 id="siteDetailName" style="font-size: 20px; font-weight: 700; margin-bottom: 16px;"></h2>
            <div id="siteDetailContent" style="font-size: 14px;">
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px;">
                    <div>
                        <label style="color: var(--text-muted); font-size: 12px;">System Size (kWp)</label>
                        <div id="siteSize" style="font-size: 18px; font-weight: 600; margin-top: 4px;"></div>
                    </div>
                    <div>
                        <label style="color: var(--text-muted); font-size: 12px;">Contract Status</label>
                        <div id="siteContract" style="font-size: 18px; font-weight: 600; margin-top: 4px;"></div>
                    </div>
                    <div>
                        <label style="color: var(--text-muted); font-size: 12px;">SPV Code</label>
                        <div id="siteSPV" style="font-size: 16px; margin-top: 4px;"></div>
                    </div>
                    <div>
                        <label style="color: var(--text-muted); font-size: 12px;">Onboard Date</label>
                        <div id="siteDate" style="font-size: 16px; margin-top: 4px;"></div>
                    </div>
                    <div>
                        <label style="color: var(--text-muted); font-size: 12px;">PM Cost</label>
                        <div id="sitePMCost" style="font-size: 16px; margin-top: 4px;"></div>
                    </div>
                    <div>
                        <label style="color: var(--text-muted); font-size: 12px;">CCTV Cost</label>
                        <div id="siteCCTVCost" style="font-size: 16px; margin-top: 4px;"></div>
                    </div>
                    <div>
                        <label style="color: var(--text-muted); font-size: 12px;">Cleaning Cost</label>
                        <div id="siteCleaningCost" style="font-size: 16px; margin-top: 4px;"></div>
                    </div>
                    <div>
                        <label style="color: var(--text-muted); font-size: 12px;">Monthly Fee</label>
                        <div id="siteMonthlyFee" style="font-size: 18px; font-weight: 600; color: var(--green); margin-top: 4px;"></div>
                    </div>
                </div>
            </div>
            <div style="margin-top: 24px; display: flex; gap: 12px;">
                <button onclick="closeSiteModal()" style="flex: 1; padding: 10px; background: #e5e7eb; color: var(--text); border: none; border-radius: 8px; font-weight: 600; cursor: pointer;">Close</button>
            </div>
        </div>
    </div>

    <script>

                // Flexible Import Handler
                let pendingImportData = null;

                function mapColumns(headers, data) {
                    // Column name mappings - supports variations
                    const columnMappings = {
                        name: ['site name', 'site', 'name', 'title', 'project'],
                        systemSizeKwp: ['system size', 'size', 'capacity', 'kwp', 'kw', 'power'],
                        contract: ['contract', 'contracted', 'contract status', 'status'],
                        onboardDate: ['onboard date', 'onboard', 'date', 'start date', 'commissioned'],
                        spvCode: ['spv', 'spv code', 'spv name', 'company', 'entity'],
                        pmCost: ['pm cost', 'pm', 'preventive maintenance'],
                        cctvCost: ['cctv', 'cctv cost', 'inspection'],
                        cleaningCost: ['cleaning', 'cleaning cost', 'panel cleaning']
                    };

                    // Find matching columns
                    const mapping = {};
                    const lowerHeaders = headers.map(h => (h || '').toString().toLowerCase().trim());

                    for (const [key, aliases] of Object.entries(columnMappings)) {
                        for (let i = 0; i < lowerHeaders.length; i++) {
                            const headerLower = lowerHeaders[i];
                            if (aliases.some(alias => headerLower.includes(alias) || alias.includes(headerLower.split(' ')[0]))) {
                                mapping[key] = i;
                                break;
                            }
                        }
                    }

                    return mapping;
                }

                function parseImportData(headers, rows, mapping) {
                    return rows.map(row => {
                        const site = {
                            id: Math.random() * 10000,
                            name: row[mapping.name] ? String(row[mapping.name]).trim() : 'Unknown Site',
                            systemSizeKwp: mapping.systemSizeKwp ? parseFloat(row[mapping.systemSizeKwp]) || 0 : 0,
                            contract: mapping.contract ? (String(row[mapping.contract]).toLowerCase().includes('yes') ? 'Yes' : 'No') : 'No',
                            onboardDate: mapping.onboardDate ? row[mapping.onboardDate] : null,
                            spvCode: mapping.spvCode ? String(row[mapping.spvCode]).trim() : null,
                            pmCost: mapping.pmCost ? parseFloat(row[mapping.pmCost]) || 0 : 0,
                            cctvCost: mapping.cctvCost ? parseFloat(row[mapping.cctvCost]) || 0 : 0,
                            cleaningCost: mapping.cleaningCost ? parseFloat(row[mapping.cleaningCost]) || 0 : 0,
                            siteType: 'Rooftop',
                            contractStatus: mapping.contract ? (String(row[mapping.contract]).toLowerCase().includes('yes') ? 'Yes' : 'No') : 'NO'
                        };
                        return site;
                    }).filter(s => s.name !== 'Unknown Site' && s.systemSizeKwp > 0);
                }

                function handleFileImport(file) {
                    if (!file.name.endsWith('.csv')) {
                        alert('Please upload a CSV file. Convert your Excel spreadsheet to CSV first.');
                        return;
                    }

                    const reader = new FileReader();
                    reader.onload = function(e) {
                        try {
                            const text = e.target.result;
                            const lines = text.split('\n');

                            if (lines.length < 5) {
                                alert('CSV file appears to be empty or invalid');
                                return;
                            }

                            // Parse all lines as arrays
                            const parsedLines = lines.map(line => {
                                const cells = [];
                                let current = '';
                                let inQuotes = false;
                                for (let char of line) {
                                    if (char === '"') {
                                        inQuotes = !inQuotes;
                                    } else if (char === ',' && !inQuotes) {
                                        cells.push(current.trim().replace(/^"|"$/g, ''));
                                        current = '';
                                    } else {
                                        current += char;
                                    }
                                }
                                cells.push(current.trim().replace(/^"|"$/g, ''));
                                return cells;
                            }).filter(r => r.some(v => v));

                            // Find the header row (contains "Site" in first column)
                            let headerRowIdx = -1;
                            for (let i = 0; i < parsedLines.length; i++) {
                                const firstCell = parsedLines[i][0]?.toLowerCase() || '';
                                if (firstCell.includes('site') && parsedLines[i].some(c => c?.toLowerCase().includes('system'))) {
                                    headerRowIdx = i;
                                    break;
                                }
                            }

                            if (headerRowIdx === -1) {
                                alert('Could not find header row with "Site" and "System Size"');
                                return;
                            }

                            const headers = parsedLines[headerRowIdx];
                            const rows = parsedLines.slice(headerRowIdx + 1).filter(r => r[0]?.trim() && r[0].trim() !== 'Total');

                            if (rows.length === 0) {
                                alert('No site data found in spreadsheet');
                                return;
                            }

                            processImportData(headers, rows);
                        } catch (error) {
                            alert('Error reading CSV: ' + error.message);
                            console.error(error);
                        }
                    };
                    reader.readAsText(file);
                }

                function processImportData(headers, rows) {
                    if (rows.length === 0) {
                        alert('No data found in spreadsheet!');
                        return;
                    }

                    const mapping = mapColumns(headers, rows);
                    pendingImportData = parseImportData(headers, rows, mapping);

                    // Show preview
                    const preview = document.getElementById('mappingTable');
                    preview.innerHTML = `
                        <div style="background: #f9fafb; padding: 12px; border-radius: 6px; margin-bottom: 12px; font-size: 13px;">
                            <strong>Found ${pendingImportData.length} sites</strong><br>
                            Sample data:
                        </div>
                        <table style="width: 100%; font-size: 12px; border-collapse: collapse;">
                            <tr style="background: #f3f4f6;">
                                <th style="padding: 8px; text-align: left; border-bottom: 1px solid var(--border);">Site Name</th>
                                <th style="padding: 8px; text-align: left; border-bottom: 1px solid var(--border);">Size (kWp)</th>
                                <th style="padding: 8px; text-align: left; border-bottom: 1px solid var(--border);">Contract</th>
                                <th style="padding: 8px; text-align: left; border-bottom: 1px solid var(--border);">SPV</th>
                            </tr>
                            ${pendingImportData.slice(0, 5).map(s => `
                                <tr style="border-bottom: 1px solid var(--border);">
                                    <td style="padding: 8px;">${s.name}</td>
                                    <td style="padding: 8px;">${s.systemSizeKwp}</td>
                                    <td style="padding: 8px;">${s.contract}</td>
                                    <td style="padding: 8px;">${s.spvCode || '‚Äî'}</td>
                                </tr>
                            `).join('')}
                        </table>
                    `;

                    document.getElementById('columnMappingUI').style.display = 'block';
                }

                function confirmImport() {
                    if (pendingImportData && pendingImportData.length > 0) {
                        sites = pendingImportData;
                        calculatePortfolio();
                        calculateDashboard();
                        updateDashboard();

                        document.getElementById('columnMappingUI').style.display = 'none';
                        const status = document.getElementById('importStatus');
                        status.style.display = 'block';
                        status.textContent = `‚úÖ Successfully imported ${sites.length} sites!`;
                        status.style.color = 'var(--green)';

                        showPage('dashboard');
                    }
                }

                function cancelImport() {
                    pendingImportData = null;
                    document.getElementById('columnMappingUI').style.display = 'none';
                    document.getElementById('fileInput').value = '';
                }

                // Setup drag and drop
                document.addEventListener('DOMContentLoaded', function() {
                    const importZone = document.getElementById('importZone');
                    const fileInput = document.getElementById('fileInput');

                    if (importZone && fileInput) {
                        importZone.addEventListener('click', () => fileInput.click());

                        importZone.addEventListener('dragover', (e) => {
                            e.preventDefault();
                            importZone.style.background = '#f3f4f6';
                            importZone.style.borderColor = 'var(--blue)';
                        });

                        importZone.addEventListener('dragleave', () => {
                            importZone.style.background = '';
                            importZone.style.borderColor = '';
                        });

                        importZone.addEventListener('drop', (e) => {
                            e.preventDefault();
                            importZone.style.background = '';
                            if (e.dataTransfer.files.length > 0) {
                                handleFileImport(e.dataTransfer.files[0]);
                            }
                        });

                        fileInput.addEventListener('change', function() {
                            if (fileInput.files.length > 0) {
                                handleFileImport(fileInput.files[0]);
                            }
                        });
                    }
                });
        // ========================================
        // SHAREPOINT REST API INTEGRATION
        // O&M Portfolio Tracker - SharePoint Version
        // ========================================

        // SharePoint Context
        const SP_CONFIG = {
            siteUrl: typeof _spPageContextInfo !== 'undefined' ? _spPageContextInfo.webAbsoluteUrl : window.location.origin,
            listsUrl: typeof _spPageContextInfo !== 'undefined' ? _spPageContextInfo.webAbsoluteUrl + '/_api/web/lists' : '/_api/web/lists'
        };

        // Global Data Storage
        let sites = [];
        let spvs = [];
        let rateTiers = [];
        let portfolio = {};
        let dashboard = {};

        // Mock Data for Local Testing
        const MOCK_SITES = [
            { ID: 1, Title: 'Meadow Solar Farm', SystemSizeKwp: 2450, SiteType: 'Ground Mount', ContractStatus: 'Yes', OnboardDate: '2023-01-15', PMCost: 500, CCTVCost: 200, CleaningCost: 300, SPVCode: 'OS2' },
            { ID: 2, Title: 'Hilltop Energy Park', SystemSizeKwp: 1850, SiteType: 'Rooftop', ContractStatus: 'Yes', OnboardDate: '2023-02-20', PMCost: 450, CCTVCost: 150, CleaningCost: 250, SPVCode: 'AD1' },
            { ID: 3, Title: 'Valley View Solar', SystemSizeKwp: 3200, SiteType: 'Ground Mount', ContractStatus: 'Yes', OnboardDate: '2023-03-10', PMCost: 600, CCTVCost: 250, CleaningCost: 400, SPVCode: 'OS2' },
            { ID: 4, Title: 'Riverside Solar', SystemSizeKwp: 1500, SiteType: 'Rooftop', ContractStatus: 'No', OnboardDate: null, PMCost: 350, CCTVCost: 100, CleaningCost: 150, SPVCode: 'EM3' },
            { ID: 5, Title: 'Lakeside Power', SystemSizeKwp: 2100, SiteType: 'Ground Mount', ContractStatus: 'Yes', OnboardDate: '2023-05-12', PMCost: 480, CCTVCost: 180, CleaningCost: 280, SPVCode: 'ESI10' },
            { ID: 6, Title: 'Forest Edge', SystemSizeKwp: 950, SiteType: 'Rooftop', ContractStatus: 'Yes', OnboardDate: '2023-06-08', PMCost: 280, CCTVCost: 80, CleaningCost: 120, SPVCode: 'FS' },
            { ID: 7, Title: 'Ocean View', SystemSizeKwp: 3600, SiteType: 'Ground Mount', ContractStatus: 'Yes', OnboardDate: '2023-07-18', PMCost: 700, CCTVCost: 300, CleaningCost: 450, SPVCode: 'AD1' },
            { ID: 8, Title: 'Mountain Ridge', SystemSizeKwp: 2200, SiteType: 'Ground Mount', ContractStatus: 'No', OnboardDate: null, PMCost: 500, CCTVCost: 200, CleaningCost: 300, SPVCode: 'OS2' }
        ];

        const MOCK_SPVS = [
            { Title: 'OS2', SPVName: 'Olympus Solar 2 Ltd' },
            { Title: 'AD1', SPVName: 'Artemis Development Ltd' },
            { Title: 'EM3', SPVName: 'Ember Energy 3' },
            { Title: 'ESI10', SPVName: 'Enviro Solar Investments 10' },
            { Title: 'FS', SPVName: 'Frontier Solar' }
        ];

        const MOCK_RATE_TIERS = [
            { Title: '30-40MW', MinCapacityMW: 30, MaxCapacityMW: 40, RatePerKwp: 1.70, IsActive: true },
            { Title: '20-30MW', MinCapacityMW: 20, MaxCapacityMW: 30, RatePerKwp: 1.80, IsActive: true },
            { Title: '<20MW', MinCapacityMW: 0, MaxCapacityMW: 20, RatePerKwp: 2.00, IsActive: true }
        ];
        const DEFAULT_RATE_TIER = {
            tierName: '<20MW',
            minCapacityMW: 0,
            maxCapacityMW: null,
            ratePerKwp: 2.00,
            isActive: true
        };

        // Get Request Digest for POST/UPDATE/DELETE operations
        function getRequestDigest() {
            const digestElement = document.getElementById('__REQUESTDIGEST');
            if (digestElement) {
                return digestElement.value;
            }
            // Fallback: Fetch new digest
            return fetch(SP_CONFIG.siteUrl + '/_api/contextinfo', {
                method: 'POST',
                headers: {
                    'Accept': 'application/json;odata=verbose'
                }
            })
            .then(r => r.json())
            .then(d => d.d.GetContextWebInformation.FormDigestValue);
        }

        // Generic SharePoint GET request
        async function spGet(listName, query = '') {
            const url = `${SP_CONFIG.listsUrl}/getbytitle('${listName}')/items${query ? '?' + query : '?$top=5000'}`;

            try {
                const response = await fetch(url, {
                    headers: {
                        'Accept': 'application/json;odata=verbose'
                    }
                });

                if (!response.ok) {
                    throw new Error(`SharePoint API error: ${response.status}`);
                }

                const data = await response.json();
                return data.d.results;
            } catch (error) {
                console.error(`Error fetching from ${listName}:`, error);
                return [];
            }
        }

        // Load Sites from SharePoint (or use mock data locally)
        async function loadSites() {
            let spSites = await spGet('Sites', '$select=*&$top=5000&$orderby=Title');

            // Use mock data as fallback if no data from SharePoint
            if (!spSites || spSites.length === 0) {
                console.log('üìã Using mock data for Sites (SharePoint not connected)');
                spSites = MOCK_SITES;
            }

            sites = spSites.map(site => ({
                id: site.ID,
                name: site.Title,
                systemSizeKwp: site.SystemSizeKwp || 0,
                siteType: site.SiteType || 'Rooftop',
                contractStatus: site.ContractStatus || 'NO',
                contract: site.ContractStatus === 'Yes' ? 'Yes' : 'No',
                onboardDate: site.OnboardDate,
                pmCost: site.PMCost || 0,
                cctvCost: site.CCTVCost || 0,
                cleaningCost: site.CleaningCost || 0,
                spvCode: site.SPVCode || null
            }));

            return sites;
        }

        // Load SPVs from SharePoint (or use mock data locally)
        async function loadSPVs() {
            let spSPVs = await spGet('SPVs', '$select=*&$orderby=Title');

            // Use mock data as fallback if no data from SharePoint
            if (!spSPVs || spSPVs.length === 0) {
                console.log('üìã Using mock data for SPVs (SharePoint not connected)');
                spSPVs = MOCK_SPVS;
            }

            spvs = spSPVs.map(spv => ({
                code: spv.Title,
                name: spv.SPVName || spv.Title
            }));

            return spvs;
        }

        // Load Rate Tiers from SharePoint (or use mock data locally)
        async function loadRateTiers() {
            let spTiers = await spGet('RateTiers', '$select=*&$filter=IsActive eq true&$orderby=MinCapacityMW desc');

            // Use mock data as fallback if no data from SharePoint
            if (!spTiers || spTiers.length === 0) {
                console.log('üìã Using mock data for Rate Tiers (SharePoint not connected)');
                spTiers = MOCK_RATE_TIERS;
            }

            rateTiers = spTiers.map(tier => ({
                tierName: tier.Title,
                minCapacityMW: tier.MinCapacityMW || 0,
                maxCapacityMW: tier.MaxCapacityMW,
                ratePerKwp: tier.RatePerKwp || 2.00,
                isActive: tier.IsActive
            }));

            if (!rateTiers.length) {
                console.warn('No rate tiers returned from SharePoint. Using default tier.');
                rateTiers = [DEFAULT_RATE_TIER];
            }

            return rateTiers;
        }

        // Get applicable rate tier for given capacity
        function getRateTier(contractedMW) {
            if (!rateTiers || !rateTiers.length) {
                return DEFAULT_RATE_TIER;
            }
            for (let tier of rateTiers) {
                if (contractedMW >= tier.minCapacityMW) {
                    if (!tier.maxCapacityMW || contractedMW < tier.maxCapacityMW) {
                        return tier;
                    }
                }
            }
            return rateTiers[rateTiers.length - 1] || DEFAULT_RATE_TIER;
        }

        // Calculate fees for a site
        function calculateSiteFees(site, ratePerKwp) {
            const siteFixedCosts = site.pmCost + site.cctvCost + site.cleaningCost;
            const portfolioCost = site.systemSizeKwp * ratePerKwp;
            const fixedFee = siteFixedCosts + portfolioCost;
            const monthlyFee = site.contract === 'Yes' ? fixedFee / 12 : 0;

            return {
                siteFixedCosts,
                portfolioCost,
                fixedFee,
                monthlyFee
            };
        }

        // Calculate portfolio summary
        function calculatePortfolio() {
            const totalSites = sites.length;
            const contractedSites = sites.filter(s => s.contract === 'Yes');
            const totalCapacityKwp = sites.reduce((sum, s) => sum + s.systemSizeKwp, 0);
            const contractedCapacityKwp = contractedSites.reduce((sum, s) => sum + s.systemSizeKwp, 0);

            const totalCapacityMW = totalCapacityKwp / 1000;
            const contractedCapacityMW = contractedCapacityKwp / 1000;

            const tier = getRateTier(contractedCapacityMW);

            let totalMonthlyRevenue = 0;
            contractedSites.forEach(site => {
                const fees = calculateSiteFees(site, tier.ratePerKwp);
                totalMonthlyRevenue += fees.monthlyFee;
            });

            portfolio = {
                totalSites,
                contractedSites: contractedSites.length,
                totalCapacityMW,
                contractedCapacityMW,
                currentTier: tier.tierName,
                ratePerKwp: tier.ratePerKwp,
                totalMonthlyRevenue,
                totalAnnualRevenue: totalMonthlyRevenue * 12
            };

            return portfolio;
        }

        // Calculate dashboard data
        function calculateDashboard() {
            const tier = getRateTier(portfolio.contractedCapacityMW);

            sites.forEach(site => {
                const fees = calculateSiteFees(site, tier.ratePerKwp);
                Object.assign(site, fees);
            });

            const topSites = sites
                .filter(s => s.contract === 'Yes')
                .sort((a, b) => b.monthlyFee - a.monthlyFee)
                .slice(0, 5)
                .map(s => ({
                    name: s.name,
                    spv: s.spvCode || 'N/A',
                    size: s.systemSizeKwp,
                    monthlyFee: s.monthlyFee
                }));

            const revenueTrend = Array.from({ length: 12 }, (_, i) => ({
                month: ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'][i],
                revenue: portfolio.totalMonthlyRevenue * (0.7 + (i * 0.025))
            }));

            dashboard = {
                topSites,
                revenueTrend,
                contractStatus: {
                    contracted: portfolio.contractedSites,
                    notContracted: portfolio.totalSites - portfolio.contractedSites
                }
            };

            const spvSummary = {};
            sites.forEach(site => {
                const code = site.spvCode || 'Unknown';
                if (!spvSummary[code]) {
                    spvSummary[code] = {
                        code,
                        name: spvs.find(s => s.code === code)?.name || code,
                        sites: 0,
                        contracted: 0,
                        capacity: 0,
                        revenue: 0
                    };
                }

                spvSummary[code].sites++;
                spvSummary[code].capacity += site.systemSizeKwp;

                if (site.contract === 'Yes') {
                    spvSummary[code].contracted++;
                    spvSummary[code].revenue += site.monthlyFee || 0;
                }
            });

            spvs = Object.values(spvSummary);
            return dashboard;
        }

        // UI Functions
        function formatCurrency(value) {
            return '¬£' + (value || 0).toLocaleString('en-GB', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
        }

        function showPage(pageId) {
            document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
            document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));

            const page = document.getElementById(pageId);
            if (page) page.classList.add('active');

            // Find and activate the corresponding nav item
            const navItem = document.querySelector(`a.nav-item[onclick*="'${pageId}'"]`);
            if (navItem) navItem.classList.add('active');
        }

        function updateDashboard() {
            // Update stat cards
            const statCards = document.querySelectorAll('.stats-grid .card');
            if (statCards[0]) {
                statCards[0].querySelector('.card-value').textContent = portfolio.totalSites || 0;
                statCards[0].querySelector('.card-sub').innerHTML = `<span>${portfolio.contractedSites || 0}</span> contracted`;
            }
            if (statCards[1]) {
                statCards[1].querySelector('.card-value').textContent = `${(portfolio.totalCapacityMW || 0).toFixed(1)} MW`;
                statCards[1].querySelector('.card-sub').innerHTML = `<span>${(portfolio.contractedCapacityMW || 0).toFixed(1)} MW</span> contracted`;
            }
            if (statCards[2]) {
                statCards[2].querySelector('.card-value').textContent = formatCurrency(portfolio.totalMonthlyRevenue || 0);
                statCards[2].querySelector('.card-sub').innerHTML = `<span>${formatCurrency(portfolio.totalAnnualRevenue || 0)}</span> annually`;
            }
            if (statCards[3]) {
                statCards[3].querySelector('.card-value').textContent = portfolio.currentTier || '<20MW';
                statCards[3].querySelector('.card-sub').innerHTML = `<span>¬£${(portfolio.ratePerKwp || 2.00).toFixed(2)}</span>/kWp rate`;
            }

            // Render tables and charts
            renderTopSites();
            renderTopSPVs();
            renderSitesTable();
            renderSPVsTable();
            initCharts();
        }

        function openSiteModal(siteId) {
            const site = sites.find(s => s.id === siteId);
            if (!site) return;

            document.getElementById('siteDetailName').textContent = site.name;
            document.getElementById('siteSize').textContent = site.systemSizeKwp.toLocaleString() + ' kWp';
            document.getElementById('siteContract').innerHTML = `<span class="status-badge ${site.contract === 'Yes' ? 'status-yes' : 'status-no'}">${site.contract}</span>`;
            document.getElementById('siteSPV').textContent = site.spvCode || '‚Äî';
            document.getElementById('siteDate').textContent = site.onboardDate ? new Date(site.onboardDate).toLocaleDateString('en-GB') : '‚Äî';
            document.getElementById('sitePMCost').textContent = formatCurrency(site.pmCost);
            document.getElementById('siteCCTVCost').textContent = formatCurrency(site.cctvCost);
            document.getElementById('siteCleaningCost').textContent = formatCurrency(site.cleaningCost);
            document.getElementById('siteMonthlyFee').textContent = formatCurrency(site.monthlyFee || 0);

            document.getElementById('siteDetailModal').style.display = 'flex';
        }

        function closeSiteModal() {
            document.getElementById('siteDetailModal').style.display = 'none';
        }

        function renderTopSites() {
            const tbody = document.querySelector('#dashboard .chart-card:nth-child(3) tbody');
            if (!tbody || !dashboard.topSites) return;

            tbody.innerHTML = dashboard.topSites.map(site => {
                const siteData = sites.find(s => s.name === site.name);
                return `
                    <tr>
                        <td><a href="#" class="site-link" onclick="openSiteModal(${siteData.id}); return false;">${site.name}</a></td>
                        <td>${site.spv}</td>
                        <td>${site.size.toLocaleString()} kWp</td>
                        <td style="font-weight: 600;">${formatCurrency(site.monthlyFee)}</td>
                    </tr>
                `;
            }).join('');
        }

        function renderTopSPVs() {
            const tbody = document.querySelector('#dashboard .chart-card:nth-child(4) tbody');
            if (!tbody || !spvs) return;

            const topSPVs = spvs.sort((a, b) => b.revenue - a.revenue).slice(0, 5);
            tbody.innerHTML = topSPVs.map(spv => `
                <tr>
                    <td style="font-weight: 600;">${spv.code}</td>
                    <td>${spv.name}</td>
                    <td>${spv.sites}</td>
                    <td><span class="badge badge-green">${spv.contracted}</span></td>
                    <td>${formatCurrency(spv.revenue)}</td>
                </tr>
            `).join('');
        }

        function renderSitesTable() {
            const tbody = document.getElementById('sitesBody');
            if (!tbody) return;

            if (!sites.length) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="9" style="text-align: center; padding: 16px; color: var(--text-muted);">
                            No site data loaded. Upload a spreadsheet to import site data.
                        </td>
                    </tr>
                `;
                return;
            }

            tbody.innerHTML = sites.map(site => `
                <tr>
                    <td><a href="#" class="site-link" onclick="openSiteModal(${site.id}); return false;">${site.name}</a></td>
                    <td>${site.systemSizeKwp.toLocaleString()}</td>
                    <td>${site.siteType || 'Rooftop'}</td>
                    <td><span class="status-badge ${site.contract === 'Yes' ? 'status-yes' : 'status-no'}">${site.contract}</span></td>
                    <td>${site.onboardDate ? new Date(site.onboardDate).toLocaleDateString('en-GB') : '‚Äî'}</td>
                    <td>${site.spvCode || '‚Äî'}</td>
                    <td>${formatCurrency(site.siteFixedCosts || (site.pmCost + site.cctvCost + site.cleaningCost))}</td>
                    <td>${formatCurrency(site.fixedFee || 0)}</td>
                    <td style="font-weight: 600; color: ${site.contract === 'Yes' ? 'var(--green)' : 'var(--text-muted)'}">
                        ${site.contract === 'Yes' ? formatCurrency(site.monthlyFee || 0) : '‚Äî'}
                    </td>
                    <td>
                        <button onclick="editSite('${site.id}')" style="background: var(--blue); color: white; border: none; padding: 4px 12px; border-radius: 4px; cursor: pointer; margin-right: 4px; font-size: 12px;">Edit</button>
                        <button onclick="deleteSite('${site.id}')" style="background: var(--red); color: white; border: none; padding: 4px 12px; border-radius: 4px; cursor: pointer; font-size: 12px;">Delete</button>
                    </td>
                </tr>
            `).join('');
        }

        // Edit site function
        async function editSite(siteId) {
            const site = sites.find(s => s.id === siteId);
            if (!site) {
                alert('Site not found');
                return;
            }

            // Create a simple prompt-based editor (for SharePoint version)
            const newName = prompt('Site Name:', site.name);
            if (newName === null) return; // Cancelled

            const newSize = parseFloat(prompt('System Size (kWp):', site.systemSizeKwp));
            if (isNaN(newSize)) {
                alert('Invalid system size');
                return;
            }

            const newType = prompt('Site Type (Rooftop or Ground Mount):', site.siteType || 'Rooftop');
            const newContract = prompt('Contract Status (Yes or No):', site.contract || 'No');
            const newSPV = prompt('SPV Code:', site.spvCode || '');
            const newPM = parseFloat(prompt('PM Cost (¬£):', site.pmCost || 0));
            const newCCTV = parseFloat(prompt('CCTV Cost (¬£):', site.cctvCost || 0));
            const newCleaning = parseFloat(prompt('Cleaning Cost (¬£):', site.cleaningCost || 0));

            // Update in SharePoint List
            try {
                const digest = await getRequestDigest();
                const listUrl = `${SP_CONFIG.listsUrl}/getbytitle('Sites')/items(${siteId})`;

                await fetch(listUrl, {
                    method: 'POST',
                    headers: {
                        'Accept': 'application/json;odata=verbose',
                        'Content-Type': 'application/json;odata=verbose',
                        'X-RequestDigest': digest,
                        'IF-MATCH': '*',
                        'X-HTTP-Method': 'MERGE'
                    },
                    body: JSON.stringify({
                        __metadata: { type: 'SP.Data.SitesListItem' },
                        Title: newName,
                        SystemSizeKwp: newSize,
                        SiteType: newType,
                        ContractStatus: newContract,
                        SPVCode: newSPV,
                        PMCost: newPM || 0,
                        CCTVCost: newCCTV || 0,
                        CleaningCost: newCleaning || 0
                    })
                });

                alert('Site updated successfully!');

                // Reload data
                await initializeApp();
            } catch (error) {
                console.error('Error updating site:', error);
                alert('Failed to update site: ' + error.message);
            }
        }

        // Delete site function
        async function deleteSite(siteId) {
            const site = sites.find(s => s.id === siteId);
            if (!site) {
                alert('Site not found');
                return;
            }

            if (!confirm(`Are you sure you want to delete "${site.name}"?`)) {
                return;
            }

            try {
                const digest = await getRequestDigest();
                const listUrl = `${SP_CONFIG.listsUrl}/getbytitle('Sites')/items(${siteId})`;

                await fetch(listUrl, {
                    method: 'POST',
                    headers: {
                        'Accept': 'application/json;odata=verbose',
                        'X-RequestDigest': digest,
                        'IF-MATCH': '*',
                        'X-HTTP-Method': 'DELETE'
                    }
                });

                alert('Site deleted successfully!');

                // Reload data
                await initializeApp();
            } catch (error) {
                console.error('Error deleting site:', error);
                alert('Failed to delete site: ' + error.message);
            }
        }

        function renderSPVsTable() {
            const tbody = document.getElementById('spvsBody');
            if (!tbody) return;

            tbody.innerHTML = spvs.map(spv => `
                <tr>
                    <td style="font-weight: 600;">${spv.code}</td>
                    <td>${spv.name}</td>
                    <td>${spv.sites}</td>
                    <td><span class="badge badge-green">${spv.contracted}</span></td>
                    <td>${(spv.capacity / 1000).toFixed(2)} MW</td>
                    <td style="font-weight: 600;">${formatCurrency(spv.revenue)}</td>
                    <td style="font-weight: 600;">${formatCurrency(spv.revenue * 12)}</td>
                </tr>
            `).join('');
        }

        function filterSites() {
            const search = document.getElementById('siteSearch')?.value.toLowerCase() || '';
            const tbody = document.getElementById('sitesBody');
            if (!tbody || !sites) return;

            const filtered = sites.filter(site =>
                site.name.toLowerCase().includes(search) ||
                site.spvCode?.toLowerCase().includes(search) ||
                site.systemSizeKwp.toString().includes(search)
            );

            tbody.innerHTML = filtered.map(site => `
                <tr>
                    <td><a href="#" class="site-link">${site.name}</a></td>
                    <td>${site.systemSizeKwp.toLocaleString()}</td>
                    <td><span class="status-badge ${site.contract === 'Yes' ? 'status-yes' : 'status-no'}">${site.contract}</span></td>
                    <td>${site.onboardDate ? new Date(site.onboardDate).toLocaleDateString('en-GB') : '‚Äî'}</td>
                    <td>${site.spvCode || '‚Äî'}</td>
                    <td>${formatCurrency(site.pmCost)}</td>
                    <td>${formatCurrency(site.cctvCost)}</td>
                    <td>${formatCurrency(site.cleaningCost)}</td>
                    <td style="font-weight: 600;">${formatCurrency(site.monthlyFee || 0)}</td>
                </tr>
            `).join('');
        }

        function initCharts() {
            initRevenueChart();
            initContractChart();
            initCMChart();
        }

        function initRevenueChart() {
            const canvas = document.getElementById('revenueChart');
            if (!canvas || !dashboard.revenueTrend) return;

            const ctx = canvas.getContext('2d');
            new Chart(ctx, {
                type: 'line',
                data: {
                    labels: dashboard.revenueTrend.map(d => d.month),
                    datasets: [{
                        label: 'Revenue',
                        data: dashboard.revenueTrend.map(d => d.revenue),
                        borderColor: '#10b981',
                        backgroundColor: 'rgba(16, 185, 129, 0.1)',
                        fill: true,
                        tension: 0.4
                    }]
                },
                options: {
                    responsive: true,
                    plugins: { legend: { display: false } },
                    scales: {
                        y: { beginAtZero: false, ticks: { callback: value => '¬£' + value.toLocaleString() } }
                    }
                }
            });
        }

        function initContractChart() {
            const canvas = document.getElementById('contractChart');
            if (!canvas || !dashboard.contractStatus) return;

            const ctx = canvas.getContext('2d');
            new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: ['Contracted', 'Not Contracted'],
                    datasets: [{
                        data: [dashboard.contractStatus.contracted, dashboard.contractStatus.notContracted],
                        backgroundColor: ['#10b981', '#e5e7eb'],
                        borderWidth: 0
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: { position: 'bottom' }
                    }
                }
            });
        }

        function initCMChart() {
            const canvas = document.getElementById('cmUsageChart');
            if (!canvas) return;

            const ctx = canvas.getContext('2d');
            const months = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
            const used = [0.5, 1.2, 0.8, 1.5, 0.3, 0.9, 1.1, 0.6, 1.3, 0.7, 0.75, 0];
            const allowance = Array(12).fill(2);

            new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: months,
                    datasets: [
                        {
                            label: 'Days Used',
                            data: used,
                            backgroundColor: '#3b82f6'
                        },
                        {
                            label: 'Allowance',
                            data: allowance,
                            backgroundColor: '#e5e7eb'
                        }
                    ]
                },
                options: {
                    responsive: true,
                    scales: {
                        y: { beginAtZero: true, max: 3, title: { display: true, text: 'Days' } }
                    }
                }
            });
        }

        // Main initialization
        async function initializeApp() {
            try {
                console.log('Loading data from SharePoint...');

                await Promise.all([
                    loadSites(),
                    loadSPVs(),
                    loadRateTiers()
                ]);

                calculatePortfolio();
                calculateDashboard();
                updateDashboard();

                console.log('‚úÖ Data loaded successfully from SharePoint');
                console.log(`Sites: ${sites.length}, SPVs: ${spvs.length}, Tiers: ${rateTiers.length}`);
            } catch (error) {
                console.error('Error initializing app:', error);
                alert('Error loading data from SharePoint. Please check that the lists exist and you have access.');
            }
        }

        // Initialize on page load
        window.addEventListener('DOMContentLoaded', initializeApp);
    </script>
</body>
</html>
